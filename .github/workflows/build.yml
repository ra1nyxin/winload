name: Build & Release

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  # â”€â”€ åˆ¤æ–­æ˜¯å¦éœ€è¦æ„å»º / å‘å¸ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  check:
    name: Check commit message
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.flags.outputs.should_build }}
      should_release: ${{ steps.flags.outputs.should_release }}
      should_publish: ${{ steps.flags.outputs.should_publish }}
      should_publish_pypi: ${{ steps.flags.outputs.should_publish_pypi }}
      version: ${{ steps.flags.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Parse commit message
        id: flags
        run: |
          MSG="${{ github.event.head_commit.message }}"
          
          # ä» Cargo.toml æå–ç‰ˆæœ¬å·
          VERSION="v$(grep '^version' rust/Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "ğŸ“¦ Version: $VERSION"
          
          # PR å§‹ç»ˆæ„å»º
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "should_build=true"    >> "$GITHUB_OUTPUT"
            echo "should_release=false" >> "$GITHUB_OUTPUT"
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          # åˆå§‹åŒ–æ ‡å¿—
          BUILD=false
          RELEASE=false
          PUBLISH=false
          
          # "build publish" = æ„å»º + Release + å‘å¸ƒåˆ°åŒ…ç®¡ç†å™¨ (å…¨å¥—)
          if echo "$MSG" | grep -qi "build publish"; then
            BUILD=true
            RELEASE=true
            PUBLISH=true
          # "build release" = æ„å»º + GitHub Release
          elif echo "$MSG" | grep -qi "build release"; then
            BUILD=true
            RELEASE=true
          # "build action" = ä»…æ„å»º
          elif echo "$MSG" | grep -qi "build action"; then
            BUILD=true
          fi
          
          # "publish from release" = ä»å·²æœ‰ Release å‘å¸ƒåˆ°åŒ…ç®¡ç†å™¨ (ä¸æ„å»º)
          if echo "$MSG" | grep -qi "publish from release"; then
            PUBLISH=true
          fi
          
          # "pypi publish" / "publish pypi" = å‘å¸ƒåˆ° PyPI
          if echo "$MSG" | grep -qiE "pypi publish|publish pypi"; then
            PUBLISH_PYPI=true
          fi
          
          echo "should_build=$BUILD"     >> "$GITHUB_OUTPUT"
          echo "should_release=$RELEASE" >> "$GITHUB_OUTPUT"
          echo "should_publish=$PUBLISH" >> "$GITHUB_OUTPUT"
          echo "should_publish_pypi=$PUBLISH_PYPI" >> "$GITHUB_OUTPUT"
          
          echo "ğŸ“‹ Flags: build=$BUILD release=$RELEASE publish=$PUBLISH publish_pypi=$PUBLISH_PYPI"

  # â”€â”€ å¤šå¹³å°æ„å»º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: Build ${{ matrix.name }}
    needs: check
    if: needs.check.outputs.should_build == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # â”€â”€ Windows x64 (MSVC, native) â”€â”€
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            name: windows-x86_64
            binary: winload.exe
            asset: winload-windows-x86_64.exe

          # â”€â”€ Linux x64 (musl é™æ€é“¾æ¥, å…¼å®¹æ‰€æœ‰ Linux) â”€â”€
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            name: linux-x86_64
            binary: winload
            asset: winload-linux-x86_64
            cross_packages: musl-tools

          # â”€â”€ Windows ARM64 (cross-compile on x64 runner) â”€â”€
          - target: aarch64-pc-windows-msvc
            os: windows-latest
            name: windows-aarch64
            binary: winload.exe
            asset: winload-windows-aarch64.exe

          # â”€â”€ Linux ARM64 (ubuntu-22.04 é™ä½ GLIBC è¦æ±‚) â”€â”€
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-22.04
            name: linux-aarch64
            binary: winload
            asset: winload-linux-aarch64
            cross_linker: aarch64-linux-gnu-gcc
            cross_packages: gcc-aarch64-linux-gnu

          # â”€â”€ macOS x64 (build on Apple Silicon runner) â”€â”€
          - target: x86_64-apple-darwin
            os: macos-latest
            name: macos-x86_64
            binary: winload
            asset: winload-macos-x86_64

          # â”€â”€ macOS ARM64 (Apple Silicon runner) â”€â”€
          - target: aarch64-apple-darwin
            os: macos-latest
            name: macos-aarch64
            binary: winload
            asset: winload-macos-aarch64

          # â”€â”€ Android aarch64 (Termux ARM64) â”€â”€
          - target: aarch64-linux-android
            os: ubuntu-latest
            name: android-aarch64
            binary: winload
            asset: winload-android-aarch64

          # â”€â”€ Android x86_64 (Termux x86_64, æ¨¡æ‹Ÿå™¨ / Chromebook) â”€â”€
          - target: x86_64-linux-android
            os: ubuntu-latest
            name: android-x86_64
            binary: winload
            asset: winload-android-x86_64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust -> target
          cache-on-failure: true
          key: ${{ matrix.target }}

      - name: Install platform toolchain
        if: matrix.cross_packages
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.cross_packages }}

      # Android: é…ç½® NDK äº¤å‰ç¼–è¯‘å·¥å…·é“¾ (Termux æœ€ä½ API 24 = Android 7.0)
      - name: Setup Android NDK
        if: contains(matrix.target, 'android')
        shell: bash
        run: |
          NDK_HOME="${ANDROID_NDK_LATEST_HOME:-$ANDROID_NDK_HOME}"
          echo "ğŸ“¦ Using NDK: $NDK_HOME"
          TOOLCHAIN="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
          ls "$TOOLCHAIN" | head -20

          if [[ "${{ matrix.target }}" == "aarch64-linux-android" ]]; then
            echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=${TOOLCHAIN}/aarch64-linux-android24-clang" >> "$GITHUB_ENV"
            echo "CC_aarch64_linux_android=${TOOLCHAIN}/aarch64-linux-android24-clang" >> "$GITHUB_ENV"
            echo "AR_aarch64_linux_android=${TOOLCHAIN}/llvm-ar" >> "$GITHUB_ENV"
          elif [[ "${{ matrix.target }}" == "x86_64-linux-android" ]]; then
            echo "CARGO_TARGET_X86_64_LINUX_ANDROID_LINKER=${TOOLCHAIN}/x86_64-linux-android24-clang" >> "$GITHUB_ENV"
            echo "CC_x86_64_linux_android=${TOOLCHAIN}/x86_64-linux-android24-clang" >> "$GITHUB_ENV"
            echo "AR_x86_64_linux_android=${TOOLCHAIN}/llvm-ar" >> "$GITHUB_ENV"
          fi
          echo "âœ… Android NDK configured for ${{ matrix.target }}"

      # Windows: ä¸‹è½½ Npcap SDKï¼Œpcap crate é“¾æ¥ wpcap.lib éœ€è¦
      - name: Install Npcap SDK (Windows only)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $sdkUrl = "https://npcap.com/dist/npcap-sdk-1.13.zip"
          $zipPath = "$env:RUNNER_TEMP\npcap-sdk.zip"
          $extractPath = "$env:RUNNER_TEMP\npcap-sdk"
          
          Write-Host "ğŸ“¥ Downloading Npcap SDK..."
          Invoke-WebRequest -Uri $sdkUrl -OutFile $zipPath
          
          Write-Host "ğŸ“¦ Extracting Npcap SDK..."
          Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force
          
          # æ ¹æ® target é€‰æ‹©æ­£ç¡®çš„ lib ç›®å½•
          $target = "${{ matrix.target }}"
          if ($target -like "*aarch64*") {
            $arch = "ARM64"
          } else {
            $arch = "x64"
          }
          $libDir = "$extractPath\Lib\$arch"
          Write-Host "ğŸ“‚ Npcap SDK lib dir ($arch): $libDir"
          Get-ChildItem $libDir
          
          echo "LIB=$libDir;$env:LIB" >> $env:GITHUB_ENV
          Write-Host "âœ… Npcap SDK ready"

      - name: Install Linux packaging tools
        if: runner.os == 'Linux' && !contains(matrix.target, 'android')
        run: |
          cargo install cargo-deb cargo-generate-rpm

      - name: Build release binary
        shell: bash
        working-directory: rust
        env:
          # äº¤å‰ç¼–è¯‘æ—¶æŒ‡å®šé“¾æ¥å™¨ (ä»… aarch64-linux-gnu éœ€è¦)
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: ${{ matrix.cross_linker || '' }}
        run: |
          cargo build --release --target ${{ matrix.target }}

          # éªŒè¯ Linux musl äº§ç‰©æ˜¯å¦çœŸçš„æ˜¯é™æ€é“¾æ¥
          if [[ "${{ matrix.target }}" == *musl* ]]; then
            echo "ğŸ” Verifying static linking..."
            file target/${{ matrix.target }}/release/${{ matrix.binary }}
            ldd target/${{ matrix.target }}/release/${{ matrix.binary }} 2>&1 || echo "âœ… Statically linked (no dynamic dependencies)"
          fi

      # Linux targets: é¢å¤–æ„å»º DEB + RPM åŒ… (æ’é™¤ Android)
      - name: Build DEB & RPM packages
        if: contains(matrix.target, 'linux') && !contains(matrix.target, 'android')
        shell: bash
        working-directory: rust
        run: |
          VERSION="${{ needs.check.outputs.version }}"

          echo "ğŸ“¦ Building DEB package for ${{ matrix.target }}..."
          cargo deb --target ${{ matrix.target }} --no-build
          echo "ğŸ“¦ Building RPM package for ${{ matrix.target }}..."
          cargo generate-rpm --target ${{ matrix.target }}

          echo "âœ… Packages built (original names):"
          find target -name '*.deb' -o -name '*.rpm' | head -20

          # é‡å‘½åä¸ºç»Ÿä¸€æ ¼å¼: winload-linux-<arch>-<version>.deb / .rpm
          mkdir -p renamed
          for f in $(find target -name '*.deb'); do
            cp "$f" "renamed/winload-${{ matrix.name }}-${VERSION}.deb"
          done
          for f in $(find target -name '*.rpm'); do
            cp "$f" "renamed/winload-${{ matrix.name }}-${VERSION}.rpm"
          done
          echo "ğŸ“¦ Renamed packages:"
          ls -lh renamed/

      - name: Upload DEB artifact
        if: contains(matrix.target, 'linux') && !contains(matrix.target, 'android')
        uses: actions/upload-artifact@v4
        with:
          name: winload-${{ matrix.name }}-${{ needs.check.outputs.version }}.deb
          path: rust/renamed/*.deb

      - name: Upload RPM artifact
        if: contains(matrix.target, 'linux') && !contains(matrix.target, 'android')
        uses: actions/upload-artifact@v4
        with:
          name: winload-${{ matrix.name }}-${{ needs.check.outputs.version }}.rpm
          path: rust/renamed/*.rpm

      - name: Prepare artifact
        shell: bash
        run: |
          VERSION="${{ needs.check.outputs.version }}"
          ASSET_BASE="${{ matrix.asset }}"
          
          # åœ¨æ‰©å±•åå‰æ’å…¥ç‰ˆæœ¬å·
          # winload-linux-x86_64 -> winload-linux-x86_64-v0.1.0
          # winload-windows-x86_64.exe -> winload-windows-x86_64-v0.1.0.exe
          if [[ "$ASSET_BASE" == *.* ]]; then
            # æœ‰æ‰©å±•å
            BASE_NAME="${ASSET_BASE%.*}"
            EXTENSION="${ASSET_BASE##*.}"
            ASSET_WITH_VERSION="${BASE_NAME}-${VERSION}.${EXTENSION}"
          else
            # æ— æ‰©å±•å
            ASSET_WITH_VERSION="${ASSET_BASE}-${VERSION}"
          fi
          
          echo "ğŸ“¦ Output: $ASSET_WITH_VERSION"
          cp "rust/target/${{ matrix.target }}/release/${{ matrix.binary }}" "$ASSET_WITH_VERSION"
          echo "asset_name=$ASSET_WITH_VERSION" >> "$GITHUB_ENV"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.asset_name }}
          path: ${{ env.asset_name }}

  # â”€â”€ å‘å¸ƒåˆ° GitHub Releases â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release:
    name: Publish Release
    needs: [check, build]
    if: needs.check.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: List downloaded files
        run: |
          echo "Downloaded artifacts:"
          ls -lh

      - name: Delete existing release & tag (force fresh release)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.check.outputs.version }}"
          echo "ğŸ—‘ï¸ Cleaning up existing release/tag: $VERSION"
          gh release delete "$VERSION" --yes --cleanup-tag 2>/dev/null || echo "No existing release to delete"
          # ç­‰å¾… GitHub API åŒæ­¥
          sleep 3

      - name: Generate release notes from commits
        run: |
          VERSION="${{ needs.check.outputs.version }}"
          REPO="${{ github.repository }}"
          BASE_URL="https://github.com/${REPO}/releases/download/${VERSION}"
          
          # æŸ¥æ‰¾ä¸Šä¸€ä¸ª release tagï¼ˆæ’é™¤å½“å‰ç‰ˆæœ¬ï¼‰
          PREV_TAG=$(git tag --sort=-v:refname | grep -v "^${VERSION}$" | head -1)
          
          {
            echo "## ğŸ“¦ winload ${VERSION}"
            echo ""
            echo "### â¬‡ï¸ Downloads"
            echo ""
            echo "| Arch | Windows | Linux | macOS |"
            echo "|------|---------|-------|-------|"
            echo "| **x86_64** | [exe](${BASE_URL}/winload-windows-x86_64-${VERSION}.exe) | [binary](${BASE_URL}/winload-linux-x86_64-${VERSION}) Â· [deb](${BASE_URL}/winload-linux-x86_64-${VERSION}.deb) Â· [rpm](${BASE_URL}/winload-linux-x86_64-${VERSION}.rpm) | [binary](${BASE_URL}/winload-macos-x86_64-${VERSION}) |"
            echo "| **ARM64** | [exe](${BASE_URL}/winload-windows-aarch64-${VERSION}.exe) | [binary](${BASE_URL}/winload-linux-aarch64-${VERSION}) Â· [deb](${BASE_URL}/winload-linux-aarch64-${VERSION}.deb) Â· [rpm](${BASE_URL}/winload-linux-aarch64-${VERSION}.rpm) | [binary](${BASE_URL}/winload-macos-aarch64-${VERSION}) |"
            echo ""
            echo "**Windows (Scoop):**"
            echo '```powershell'
            echo "scoop bucket add vincentzyu https://github.com/VincentZyuApps/scoop-bucket"
            echo "scoop install winload"
            echo '```'
            echo "> ğŸ“„ [Scoop bucket](https://github.com/VincentZyuApps/scoop-bucket)"
            echo ""
            echo "**Arch Linux (AUR):**"
            echo '```bash'
            echo "paru -S winload-rust-bin"
            echo '```'
            echo "> ğŸ“„ [winload-rust-bin](https://aur.archlinux.org/packages/winload-rust-bin)"
            echo ""
            echo "**Quick install (Debian/Ubuntu/Fedora and derivatives):**"
            echo '```bash'
            echo "curl -fsSL https://raw.githubusercontent.com/${REPO}/main/docs/install_scripts/install.sh | bash"
            echo '```'
            echo "> ğŸ“„ [View install script source](https://github.com/${REPO}/blob/main/docs/install_scripts/install.sh)"
            echo ""
            echo "---"
            echo ""
            echo "### What's Changed"
            echo ""
          
            if [ -n "$PREV_TAG" ]; then
              echo "Changes since **${PREV_TAG}**:"
              echo ""
              git log "${PREV_TAG}..HEAD" --pretty=format:"- %s (\`%h\`) â€” @%an" --reverse
            else
              echo "All changes since repository creation:"
              echo ""
              git log --pretty=format:"- %s (\`%h\`) â€” @%an" --reverse
            fi
          
            echo ""
            echo ""
            echo "---"
            echo ""
            echo "### ğŸ“Š Build Info"
            echo "- **Build date**: $(date -u '+%Y-%m-%d %H:%M UTC')"
            echo "- **Commit**: [\`${GITHUB_SHA::7}\`](https://github.com/${REPO}/commit/${GITHUB_SHA})"
            echo ""
            
            if [ -n "$PREV_TAG" ]; then
              echo "**Full Changelog**: https://github.com/${REPO}/compare/${PREV_TAG}...${VERSION}"
            else
              echo "**Full Changelog**: https://github.com/${REPO}/commits/${VERSION}"
            fi
          } > release_notes.md
          
          echo "ğŸ“ Generated release notes:"
          cat release_notes.md

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.check.outputs.version }}"
          # æ”¶é›†æ‰€æœ‰è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆäºŒè¿›åˆ¶ + DEB + RPMï¼Œç»Ÿä¸€ winload-*-VERSION* æ ¼å¼ï¼‰
          shopt -s nullglob
          FILES=(winload-*-${VERSION}*)
          echo "ğŸ“¤ Uploading ${#FILES[@]} files:"
          printf '  - %s\n' "${FILES[@]}"
          gh release create "$VERSION" \
            --title "winload ${VERSION}" \
            --notes-file release_notes.md \
            --latest \
            "${FILES[@]}"

  # â”€â”€ æ›´æ–° Scoop Bucket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # è§¦å‘æ–¹å¼:
  #   - "publish from release" â†’ ä»å·²æœ‰ Release æ‹‰å–äºŒè¿›åˆ¶ï¼Œä»…æ›´æ–° Scoop
  #   - "build publish" â†’ æ„å»º + Release + æ›´æ–° Scoopï¼ˆå…¨å¥—ï¼‰
  publish-scoop:
    name: Update Scoop Bucket
    needs: [check, release]
    # always() è®©æ­¤ job å³ä½¿ release è¢«è·³è¿‡ä¹Ÿèƒ½è¿è¡Œ
    if: always() && needs.check.outputs.should_publish == 'true' && (needs.release.result == 'success' || needs.release.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Fetch latest release info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.check.outputs.version }}"
          REPO="${{ github.repository }}"
          BASE_URL="https://github.com/${REPO}/releases/download/${VERSION}"

          echo "ğŸ“¦ Target version: ${VERSION}"
          echo "ğŸ“¥ Downloading Windows binaries from release..."

          # ä¸‹è½½ Windows x64
          curl -fSL -o winload-windows-x86_64.exe \
            "${BASE_URL}/winload-windows-x86_64-${VERSION}.exe" \
            || { echo "âŒ Failed to download x64 binary"; exit 1; }

          # ä¸‹è½½ Windows ARM64
          curl -fSL -o winload-windows-aarch64.exe \
            "${BASE_URL}/winload-windows-aarch64-${VERSION}.exe" \
            || { echo "âŒ Failed to download arm64 binary"; exit 1; }

          echo "âœ… Downloaded:"
          ls -lh winload-windows-*.exe

      - name: Generate Scoop manifest
        run: |
          VERSION="${{ needs.check.outputs.version }}"
          SCOOP_VERSION="${VERSION#v}"
          REPO="${{ github.repository }}"
          BASE_URL="https://github.com/${REPO}/releases/download/${VERSION}"

          # è®¡ç®— sha256
          HASH_X64=$(sha256sum winload-windows-x86_64.exe | awk '{print $1}')
          HASH_ARM64=$(sha256sum winload-windows-aarch64.exe | awk '{print $1}')

          echo "ğŸ“¦ Version: $SCOOP_VERSION"
          echo "ğŸ”‘ x64 hash: $HASH_X64"
          echo "ğŸ”‘ arm64 hash: $HASH_ARM64"

          cat > winload.json << EOF
          {
              "version": "${SCOOP_VERSION}",
              "description": "Network Load Monitor - nload for Windows/Linux/macOS",
              "homepage": "https://github.com/${REPO}",
              "license": "MIT",
              "architecture": {
                  "64bit": {
                      "url": "${BASE_URL}/winload-windows-x86_64-${VERSION}.exe",
                      "hash": "${HASH_X64}",
                      "bin": [["winload-windows-x86_64-${VERSION}.exe", "win-nload"]]
                  },
                  "arm64": {
                      "url": "${BASE_URL}/winload-windows-aarch64-${VERSION}.exe",
                      "hash": "${HASH_ARM64}",
                      "bin": [["winload-windows-aarch64-${VERSION}.exe", "win-nload"]]
                  }
              },
              "checkver": {
                  "github": "https://github.com/${REPO}"
              },
              "autoupdate": {
                  "architecture": {
                      "64bit": {
                          "url": "https://github.com/${REPO}/releases/download/v\$version/winload-windows-x86_64-v\$version.exe"
                      },
                      "arm64": {
                          "url": "https://github.com/${REPO}/releases/download/v\$version/winload-windows-aarch64-v\$version.exe"
                      }
                  }
              }
          }
          EOF

          echo "ğŸ“ Generated winload.json:"
          cat winload.json

      - name: Push to scoop-bucket repo
        env:
          SCOOP_TOKEN: ${{ secrets.SCOOP_BUCKET_TOKEN }}
        run: |
          VERSION="${{ needs.check.outputs.version }}"

          git clone https://x-access-token:${SCOOP_TOKEN}@github.com/VincentZyuApps/scoop-bucket.git scoop-repo
          cp winload.json scoop-repo/bucket/winload.json

          cd scoop-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add bucket/winload.json
          git commit -m "ğŸº Update winload to ${VERSION}" || echo "No changes to commit"
          git push

          echo "âœ… Scoop bucket updated!"

  # â”€â”€ æ›´æ–° AUR åŒ…ï¼ˆwinload-rust-bin: é¢„ç¼–è¯‘äºŒè¿›åˆ¶ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  publish-aur-bin:
    name: Update AUR Package (winload-rust-bin)
    needs: [check, release]
    if: always() && needs.check.outputs.should_publish == 'true' && (needs.release.result == 'success' || needs.release.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Linux binaries from release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.check.outputs.version }}"
          REPO="${{ github.repository }}"
          BASE_URL="https://github.com/${REPO}/releases/download/${VERSION}"

          echo "ğŸ“¥ Downloading x86_64 binary..."
          curl -fSL -o winload-linux-x86_64 "${BASE_URL}/winload-linux-x86_64-${VERSION}"
          SHA256_X86=$(sha256sum winload-linux-x86_64 | awk '{print $1}')
          echo "ğŸ”‘ x86_64 SHA256: $SHA256_X86"
          echo "SHA256_X86=$SHA256_X86" >> "$GITHUB_ENV"

          echo "ğŸ“¥ Downloading aarch64 binary..."
          curl -fSL -o winload-linux-aarch64 "${BASE_URL}/winload-linux-aarch64-${VERSION}"
          SHA256_ARM=$(sha256sum winload-linux-aarch64 | awk '{print $1}')
          echo "ğŸ”‘ aarch64 SHA256: $SHA256_ARM"
          echo "SHA256_ARM=$SHA256_ARM" >> "$GITHUB_ENV"

      - name: Generate PKGBUILD
        run: |
          VERSION="${{ needs.check.outputs.version }}"
          TAGVER="${VERSION#v}"           # 0.1.6-beta.3 (for download URL)
          PKGVER="${TAGVER//-/.}"         # 0.1.6.beta.3 (AUR compliant)

          cat > PKGBUILD << HEREDOC_END
          # Maintainer: VincentZyu <vincentzyu233@gmail.com>
          pkgname=winload-rust-bin
          pkgver=${PKGVER}
          pkgrel=1
          pkgdesc="A lightweight, real-time CLI tool for monitoring network bandwidth and traffic"
          arch=('x86_64' 'aarch64')
          url="https://github.com/VincentZyuApps/winload"
          license=('MIT')
          provides=('winload')
          conflicts=('winload' 'winload-rust')
          _tagver=${TAGVER}
          _base_url="https://github.com/VincentZyuApps/winload/releases/download/v\${_tagver}"
          source_x86_64=("winload-linux-x86_64-v\${_tagver}::\${_base_url}/winload-linux-x86_64-v\${_tagver}")
          source_aarch64=("winload-linux-aarch64-v\${_tagver}::\${_base_url}/winload-linux-aarch64-v\${_tagver}")
          noextract=()
          sha256sums_x86_64=('${SHA256_X86}')
          sha256sums_aarch64=('${SHA256_ARM}')

          package() {
              if [[ "\$CARCH" == "x86_64" ]]; then
                  install -Dm755 "\$srcdir/winload-linux-x86_64-v\${_tagver}" "\$pkgdir/usr/bin/winload"
              elif [[ "\$CARCH" == "aarch64" ]]; then
                  install -Dm755 "\$srcdir/winload-linux-aarch64-v\${_tagver}" "\$pkgdir/usr/bin/winload"
              fi
          }
          HEREDOC_END

          # Remove leading whitespace (heredoc indentation)
          sed -i 's/^          //' PKGBUILD

          echo "ğŸ“ Generated PKGBUILD:"
          cat PKGBUILD

      - name: Generate .SRCINFO
        uses: docker://archlinux:latest
        with:
          args: bash -c "pacman -Sy --noconfirm pacman-contrib base-devel && useradd -m builder && cp PKGBUILD /home/builder/ && cd /home/builder && sudo -u builder makepkg --printsrcinfo > .SRCINFO && cp .SRCINFO /github/workspace/"

      - name: Push to AUR
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          VERSION="${{ needs.check.outputs.version }}"
          TAGVER="${VERSION#v}"           # 0.1.6-beta.3 (for download URL)
          PKGVER="${TAGVER//-/.}"         # 0.1.6.beta.3 (AUR compliant)

          # Setup SSH for AUR
          mkdir -p ~/.ssh
          echo "$AUR_SSH_KEY" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          cat >> ~/.ssh/config << 'SSHEOF'
          Host aur.archlinux.org
              IdentityFile ~/.ssh/aur
              User aur
              StrictHostKeyChecking no
          SSHEOF

          # Clone AUR repo
          git clone ssh://aur@aur.archlinux.org/winload-rust-bin.git aur-repo || {
            echo "âš ï¸ AUR repo doesn't exist yet. Please create it manually first."
            echo "   Run: ssh aur@aur.archlinux.org setup-repo winload-rust-bin"
            exit 1
          }

          # Copy files
          cp PKGBUILD aur-repo/
          cp .SRCINFO aur-repo/

          # Commit and push
          cd aur-repo
          git config user.name "VincentZyu"
          git config user.email "vincentzyu233@gmail.com"
          git add PKGBUILD .SRCINFO
          git commit -m "Update to ${PKGVER}" || echo "No changes to commit"
          git push

          echo "âœ… winload-rust-bin updated!"

  # â”€â”€ å‘å¸ƒåˆ° npmï¼ˆwinload-rust-bin: é¢„ç¼–è¯‘äºŒè¿›åˆ¶ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # åŸç†åŒ esbuild / @biomejs/biome / turbo:
  #   1. ä¸ºæ¯ä¸ªå¹³å°å‘å¸ƒä¸€ä¸ªåªå«äºŒè¿›åˆ¶çš„åŒ… (os/cpu å­—æ®µè®© npm è‡ªåŠ¨ç­›é€‰)
  #   2. ä¸»åŒ… winload-rust-bin é€šè¿‡ optionalDependencies å¼•ç”¨å®ƒä»¬
  #   3. ç”¨æˆ· npm install æ—¶åªä¸‹è½½åŒ¹é…å½“å‰å¹³å°çš„é‚£ä¸€ä¸ª
  publish-npm:
    name: Publish to npm
    needs: [check, release]
    if: always() && needs.check.outputs.should_publish == 'true' && (needs.release.result == 'success' || needs.release.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Download binaries from release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.check.outputs.version }}"
          REPO="${{ github.repository }}"
          BASE_URL="https://github.com/${REPO}/releases/download/${VERSION}"

          mkdir -p artifacts
          echo "ğŸ“¥ Downloading binaries for npm publish..."

          curl -fSL -o artifacts/winload-windows-x86_64.exe   "${BASE_URL}/winload-windows-x86_64-${VERSION}.exe"
          curl -fSL -o artifacts/winload-windows-aarch64.exe  "${BASE_URL}/winload-windows-aarch64-${VERSION}.exe"
          curl -fSL -o artifacts/winload-linux-x86_64         "${BASE_URL}/winload-linux-x86_64-${VERSION}"
          curl -fSL -o artifacts/winload-linux-aarch64        "${BASE_URL}/winload-linux-aarch64-${VERSION}"
          curl -fSL -o artifacts/winload-macos-x86_64         "${BASE_URL}/winload-macos-x86_64-${VERSION}"
          curl -fSL -o artifacts/winload-macos-aarch64        "${BASE_URL}/winload-macos-aarch64-${VERSION}"

          echo "âœ… Downloaded:"
          ls -lh artifacts/

      - name: Publish platform packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          VERSION="${{ needs.check.outputs.version }}"
          NPM_VERSION="${VERSION#v}"
          NPM_TAG="latest"
          echo "ğŸ“¦ npm version: ${NPM_VERSION} (tag: ${NPM_TAG})"

          # å¹³å°å®šä¹‰: npmåŒ…å|os|cpu|æºæ–‡ä»¶|äºŒè¿›åˆ¶å
          PLATFORMS=(
            "winload-rust-bin-win32-x64|win32|x64|artifacts/winload-windows-x86_64.exe|winload.exe"
            "winload-rust-bin-win32-arm64|win32|arm64|artifacts/winload-windows-aarch64.exe|winload.exe"
            "winload-rust-bin-linux-x64|linux|x64|artifacts/winload-linux-x86_64|winload"
            "winload-rust-bin-linux-arm64|linux|arm64|artifacts/winload-linux-aarch64|winload"
            "winload-rust-bin-darwin-x64|darwin|x64|artifacts/winload-macos-x86_64|winload"
            "winload-rust-bin-darwin-arm64|darwin|arm64|artifacts/winload-macos-aarch64|winload"
          )

          for entry in "${PLATFORMS[@]}"; do
            IFS='|' read -r PKG_NAME PKG_OS PKG_CPU SOURCE_BIN BIN_NAME <<< "$entry"
            echo ""
            echo "ğŸ“¦ Publishing ${PKG_NAME}@${NPM_VERSION}..."

            PKG_DIR="npm-platforms/${PKG_NAME}"
            mkdir -p "${PKG_DIR}/bin"

            cp "${SOURCE_BIN}" "${PKG_DIR}/bin/${BIN_NAME}"
            chmod +x "${PKG_DIR}/bin/${BIN_NAME}"

            cat > "${PKG_DIR}/package.json" << PKGJSON
          {
            "name": "${PKG_NAME}",
            "version": "${NPM_VERSION}",
            "description": "winload binary for ${PKG_OS}-${PKG_CPU}",
            "license": "MIT",
            "repository": {
              "type": "git",
              "url": "https://github.com/${{ github.repository }}"
            },
            "os": ["${PKG_OS}"],
            "cpu": ["${PKG_CPU}"],
            "files": ["bin/"]
          }
          PKGJSON

            cd "${PKG_DIR}"
            npm publish --access public --tag "${NPM_TAG}" 2>&1 || echo "âš ï¸ Failed to publish ${PKG_NAME} (may already exist)"
            cd "$GITHUB_WORKSPACE"
          done

      - name: Publish main package
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          VERSION="${{ needs.check.outputs.version }}"
          NPM_VERSION="${VERSION#v}"
          NPM_TAG="latest"

          cd npm/winload-rust-bin

          # å¤åˆ¶é¡¹ç›®æ ¹ç›®å½•çš„ README.md ä½œä¸º npm é¡µé¢å±•ç¤º
          cp ../../README.md ./README.md

          # åŠ¨æ€æ›´æ–° package.json ä¸­çš„ç‰ˆæœ¬å·ï¼ˆç‰ˆæœ¬ä»¥ Cargo.toml ä¸ºå”¯ä¸€çœŸå®æºï¼‰
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '${NPM_VERSION}';
            for (const dep of Object.keys(pkg.optionalDependencies || {})) {
              pkg.optionalDependencies[dep] = '${NPM_VERSION}';
            }
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          echo "ğŸ“¦ Publishing winload-rust-bin@${NPM_VERSION} (tag: ${NPM_TAG})..."
          cat package.json
          npm publish --access public --tag "${NPM_TAG}"

          echo "âœ… npm packages published!"

  # â”€â”€ å‘å¸ƒåˆ° PyPI (Python åŒ…) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  publish-pypi:
    name: Publish to PyPI
    needs: check
    if: needs.check.outputs.should_publish_pypi == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Build package
        working-directory: py
        run: |
          uv build

      - name: Publish to PyPI
        working-directory: py
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_TOKEN }}
        run: |
          uv publish --publish-url https://upload.pypi.org/legacy/